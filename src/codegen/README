I need to change a lot in the codegen code because it's very messy
