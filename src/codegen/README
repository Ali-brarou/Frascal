I need to change a lot in the codegen because it's very messy
